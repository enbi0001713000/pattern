<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>結果 | 行動スタイル16タイプ診断</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <main class="container" id="app"></main>

  <script type="module">
    import { loadJson, loadState, loadCurrent, clearCurrent, computeAxisMetric, scoreQuestions, summarize, scoreMap, strengthLabel } from '../assets/app.js';

    const state = loadCurrent() || loadState();
    if (!state) location.href = '../';
    clearCurrent();

    const [axes, questions, types] = await Promise.all([
      loadJson('../data/axes.json'),
      loadJson(state.mode === 100 ? '../data/questions_100.json' : '../data/questions_20.json'),
      loadJson('../data/types.json')
    ]);

    const score = scoreQuestions(questions, state.answers, axes);

    // tie-break 方式A: 同点軸の2問を重み2倍
    Object.entries(state.tieAnswers || {}).forEach(([id, value]) => {
      const m = id.match(/_TB_(..)_\d$/);
      if (!m) return;
      const axisId = m[1];
      const sc = scoreMap[value];
      if (!sc || !score[axisId]) return;
      score[axisId].L += sc.L * 2;
      score[axisId].R += sc.R * 2;
      score[axisId].n += 2;
    });

@@ -43,55 +43,61 @@
    const app = document.getElementById('app');

    const shareUrl = new URL(`../t/${code}/`, location.href).href;

    app.innerHTML = `
      <section class="card">
        <h1>診断結果</h1>
        <p class="muted">再診断はいつでも可能です。</p>
        <div class="footer-actions"><a class="btn secondary" href="../">再診断する</a></div>
      </section>

      <section class="card" style="margin-top:14px">
        <h2>表示名</h2>
        <p><strong>${state.displayName}</strong> さん</p>
      </section>

      <section class="card hero" style="margin-top:14px">
        <p class="muted">あなたの傾向タイプ</p>
        <div class="code">${code}</div>
        <h2>${type?.name || 'タイプ不明'}</h2>
        <p>${type?.catch || ''}</p>
      </section>

      <section class="card" style="margin-top:14px">
        <h2>4軸バランス</h2>
        ${metrics.map((m) => {
          const side = m.raw > 0 ? `${m.left}寄り` : m.raw < 0 ? `${m.right}寄り` : '左右拮抗';
          const level = strengthLabel(m.strength);
          const barSideClass = m.raw > 0 ? 'left' : m.raw < 0 ? 'right' : 'neutral';
          return `
          <div class="bar-wrap ${barSideClass}">
            <div class="axis-head"><span>${m.left} ↔ ${m.right}</span><span class="axis-bias">${side} / ${level}</span></div>
            <div class="axis-bar"><div class="mid"></div><div class="fill" style="width:${m.leftPct}%"></div></div>
            ${m.strength < 0.2 ? '<p class="muted" style="margin:6px 0 0">両方の要素を使い分ける傾向</p>' : ''}
          </div>`;
        }).join('')}
      </section>

      <section class="card" style="margin-top:14px">
        <h2>信頼度: ${summary.level}</h2>
        <p>overall_conf: ${(summary.overall).toFixed(2)}</p>
        <p class="muted">${summary.reason}</p>
      </section>

      <section class="card" style="margin-top:14px">
        <h2>タイプ解説</h2>
        <div class="grid2">
          <div><h3>強み</h3><ul>${(type?.strength || []).map((x)=>`<li>${x}</li>`).join('')}</ul></div>
          <div><h3>落とし穴</h3><ul>${(type?.pitfall || []).map((x)=>`<li>${x}</li>`).join('')}</ul></div>
        </div>
        <h3 style="margin-top:10px">明日の一手</h3>
        <p>${type?.nextAction || ''}</p>
        <div class="tags" style="margin-top:8px">${(type?.environment || []).map((x)=>`<span>${x}</span>`).join('')}</div>
      </section>

      <section class="card" style="margin-top:14px">
        <h2>共有</h2>
        <p>タイプページ URL: <a href="${shareUrl}">${shareUrl}</a></p>
        <div class="footer-actions">
          <button class="btn" id="copy">URLをコピー</button>
          <button class="btn secondary" id="detail">結果の短い説明</button>